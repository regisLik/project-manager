{% extends "base.html" %}

{% block header_title %}
    {% if project %}Modifier le Projet{% else %}Nouveau Projet{% endif %}
{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
    <div class="bg-white dark:bg-slate-800 rounded-lg shadow-lg overflow-hidden">
        <div class="p-6 border-b border-gray-200 dark:border-slate-700">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white">Informations du Projet</h3>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Remplissez les détails ci-dessous pour {% if project %}mettre à jour{% else %}créer{% endif %} le projet.</p>
        </div>
        
        <form method="POST" class="p-6 space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Name -->
                <div class="col-span-2">
                    <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nom du Projet</label>
                    <input type="text" name="name" id="name" required value="{{ project.name if project else '' }}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2 px-3">
                </div>

                <!-- Category -->
                <div>
                    <label for="category" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Catégorie</label>
                    <select name="category" id="category" class="mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2 px-3">
                        <option value="Développement Web" {% if project and project.category == 'Développement Web' %}selected{% endif %}>Développement Web</option>
                        <option value="Mobile" {% if project and project.category == 'Mobile' %}selected{% endif %}>Mobile</option>
                        <option value="Infrastructure" {% if project and project.category == 'Infrastructure' %}selected{% endif %}>Infrastructure</option>
                        <option value="Marketing" {% if project and project.category == 'Marketing' %}selected{% endif %}>Marketing</option>
                        <option value="Sécurité" {% if project and project.category == 'Sécurité' %}selected{% endif %}>Sécurité</option>
                        <option value="Autre" {% if project and project.category == 'Autre' %}selected{% endif %}>Autre</option>
                    </select>
                </div>

                <!-- Status -->
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Statut</label>
                    <select name="status" id="status" class="mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2 px-3">
                        <option value="Not started" {% if version and version.status == 'Not started' %}selected{% endif %}>Not started</option>
                        <option value="In progress" {% if version and version.status == 'In progress' %}selected{% endif %}>In progress</option>
                        <option value="Review" {% if version and version.status == 'Review' %}selected{% endif %}>Review</option>
                        <option value="Done" {% if version and version.status == 'Done' %}selected{% endif %}>Done</option>
                        <option value="Stopped" {% if version and version.status == 'Stopped' %}selected{% endif %}>Stopped</option>
                        <option value="Gel" {% if version and version.status == 'Gel' %}selected{% endif %}>Gel</option>
                    </select>
                </div>

                <!-- Phase -->
                <div>
                    <label for="phase" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Phase</label>
                    <select name="phase" id="phase" class="mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2 px-3">
                        <option value="Intake" {% if version and version.phase == 'Intake' %}selected{% endif %}>Intake</option>
                        <option value="Qualification" {% if version and version.phase == 'Qualification' %}selected{% endif %}>Qualification</option>
                        <option value="Scoping" {% if version and version.phase == 'Scoping' %}selected{% endif %}>Scoping</option>
                        <option value="Planning" {% if version and version.phase == 'Planning' %}selected{% endif %}>Planning</option>
                        <option value="Build" {% if version and version.phase == 'Build' %}selected{% endif %}>Build</option>
                        <option value="Test & QA" {% if version and version.phase == 'Test & QA' %}selected{% endif %}>Test & QA</option>
                        <option value="Staging" {% if version and version.phase == 'Staging' %}selected{% endif %}>Staging</option>
                        <option value="Release" {% if version and version.phase == 'Release' %}selected{% endif %}>Release</option>
                        <option value="Operate" {% if version and version.phase == 'Operate' %}selected{% endif %}>Operate</option>
                        <option value="Retro" {% if version and version.phase == 'Retro' %}selected{% endif %}>Retro</option>
                        <option value="Closed" {% if version and version.phase == 'Closed' %}selected{% endif %}>Closed</option>
                    </select>
                </div>

                <!-- Version Number -->
                <div>
                    <label for="version_number" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Version</label>
                    <input type="text" name="version_number" id="version_number" value="{{ version.version_number if version else 'V1.0.0' }}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2 px-3">
                </div>

                <!-- App Status -->
                <div>
                    <label for="app_status" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Statut Application</label>
                    <select name="app_status" id="app_status" class="mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2 px-3">
                        <option value="Building" {% if version and version.app_status == 'Building' %}selected{% endif %}>Building</option>
                        <option value="Working" {% if version and version.app_status == 'Working' %}selected{% endif %}>Working</option>
                        <option value="Not Working" {% if version and version.app_status == 'Not Working' %}selected{% endif %}>Not Working</option>
                    </select>
                </div>

                <!-- Integration Level -->
                <div>
                    <label for="integration_level" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Niveau d'intégration</label>
                    <select name="integration_level" id="integration_level" class="mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2 px-3">
                        <option value="Local" {% if version and version.integration_level == 'Local' %}selected{% endif %}>Local</option>
                        <option value="Incoming" {% if version and version.integration_level == 'Incoming' %}selected{% endif %}>Incoming</option>
                        <option value="Prod" {% if version and version.integration_level == 'Prod' %}selected{% endif %}>Prod</option>
                    </select>
                </div>

                <!-- Hosting -->
                <div>
                    <label for="hosting" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Hébergement</label>
                    <select name="hosting" id="hosting" class="mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2 px-3">
                        <option value="Cloud" {% if version and version.hosting == 'Cloud' %}selected{% endif %}>Cloud</option>
                        <option value="Services" {% if version and version.hosting == 'Services' %}selected{% endif %}>Services</option>
                    </select>
                </div>

                <!-- Accessibility -->
                <div>
                    <label for="accessibility" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Accessibilité</label>
                    <select name="accessibility" id="accessibility" class="mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2 px-3">
                        <option value="Online" {% if version and version.accessibility == 'Online' %}selected{% endif %}>Online</option>
                        <option value="Offline" {% if version and version.accessibility == 'Offline' %}selected{% endif %}>Offline</option>
                    </select>
                </div>

                <!-- Deadline -->
                <div>
                    <label for="deadline" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date Limite</label>
                    <input type="date" name="deadline" id="deadline" value="{{ version.deadline.strftime('%Y-%m-%d') if version and version.deadline else '' }}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2 px-3">
                </div>

                <!-- Progress -->
                <div>
                    <label for="progress" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Progression (%)</label>
                    <input type="number" name="progress" id="progress" min="0" max="100" value="{{ version.progress if version else 0 }}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2 px-3">
                </div>
                
                <!-- Description -->
                <div class="col-span-2">
                    <label for="description" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Description</label>
                    <textarea name="description" id="description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2 px-3">{{ version.description if version and version.description else '' }}</textarea>
                </div>

                <!-- Time Management Section -->
                <div class="col-span-2 border-t border-gray-200 dark:border-slate-700 pt-4 mt-2">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Gestion du Temps</h3>
                </div>

                <div>
                    <label for="start_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date de Début</label>
                    <input type="date" name="start_date" id="start_date" value="{{ version.start_date.strftime('%Y-%m-%d') if version and version.start_date else '' }}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2 px-3">
                </div>

                <div>
                    <label for="duration_days" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Durée (Jours ouvrés)</label>
                    <input type="number" name="duration_days" id="duration_days" min="0" value="{{ version.duration_days if version else 0 }}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2 px-3">
                </div>

                <div>
                    <label for="pause_start" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Début Pause (Vacances)</label>
                    <input type="date" name="pause_start" id="pause_start" value="{{ version.pause_start.strftime('%Y-%m-%d') if version and version.pause_start else '' }}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2 px-3">
                </div>

                <div>
                    <label for="pause_end" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Fin Pause</label>
                    <input type="date" name="pause_end" id="pause_end" value="{{ version.pause_end.strftime('%Y-%m-%d') if version and version.pause_end else '' }}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2 px-3">
                </div>

                <!-- Cost Section -->
                <div class="col-span-2 border-t border-gray-200 dark:border-slate-700 pt-4 mt-2">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Budget & Spécifications</h3>
                </div>

                <div>
                    <label for="cost" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Coût</label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="text-gray-500 sm:text-sm">€</span>
                        </div>
                        <input type="number" name="cost" id="cost" step="0.01" value="{{ version.cost if version else 0 }}" class="focus:ring-primary focus:border-primary block w-full pl-7 pr-12 sm:text-sm border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white rounded-md py-2">
                    </div>
                </div>

                <div>
                    <label for="cost_type" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Type de Coût</label>
                    <select name="cost_type" id="cost_type" class="mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2 px-3">
                        <option value="Monthly" {% if version and version.cost_type == 'Monthly' %}selected{% endif %}>Mensuel</option>
                        <option value="Annual" {% if version and version.cost_type == 'Annual' %}selected{% endif %}>Annuel</option>
                    </select>
                </div>

                <!-- Future Planning Section -->
                <div class="col-span-2 border-t border-gray-200 dark:border-slate-700 pt-4 mt-2">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Planification Future (Upgrade)</h3>
                </div>

                <div>
                    <label for="user_request_type" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Demande Utilisateur</label>
                    <select name="user_request_type" id="user_request_type" class="mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2 px-3">
                        <option value="">Sélectionner...</option>
                        <option value="Ajout de fonctionnalité" {% if version and version.user_request_type == 'Ajout de fonctionnalité' %}selected{% endif %}>Ajout de fonctionnalité</option>
                        <option value="Modification de fonctionnalité" {% if version and version.user_request_type == 'Modification de fonctionnalité' %}selected{% endif %}>Modification de fonctionnalité</option>
                        <option value="Suppression de fonctionnalité" {% if version and version.user_request_type == 'Suppression de fonctionnalité' %}selected{% endif %}>Suppression de fonctionnalité</option>
                        <option value="Ne concerne pas les utilisateurs" {% if version and version.user_request_type == 'Ne concerne pas les utilisateurs' %}selected{% endif %}>Ne concerne pas les utilisateurs</option>
                    </select>
                </div>

                <div>
                    <label for="tech_request_type" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Demande Technique</label>
                    <select name="tech_request_type" id="tech_request_type" class="mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2 px-3">
                        <option value="">Sélectionner...</option>
                        <option value="Ajout de fonctionnalité" {% if version and version.tech_request_type == 'Ajout de fonctionnalité' %}selected{% endif %}>Ajout de fonctionnalité</option>
                        <option value="Modification de fonctionnalité" {% if version and version.tech_request_type == 'Modification de fonctionnalité' %}selected{% endif %}>Modification de fonctionnalité</option>
                        <option value="Suppression de fonctionnalité" {% if version and version.tech_request_type == 'Suppression de fonctionnalité' %}selected{% endif %}>Suppression de fonctionnalité</option>
                        <option value="Refactorisation" {% if version and version.tech_request_type == 'Refactorisation' %}selected{% endif %}>Refactorisation</option>
                        <option value="Migration" {% if version and version.tech_request_type == 'Migration' %}selected{% endif %}>Migration</option>
                        <option value="Optimization" {% if version and version.tech_request_type == 'Optimization' %}selected{% endif %}>Optimization</option>
                        <option value="Refonte graphique" {% if version and version.tech_request_type == 'Refonte graphique' %}selected{% endif %}>Refonte graphique</option>
                    </select>
                </div>

                <div>
                    <label for="planned_improvement" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amélioration prévue ?</label>
                    <select name="planned_improvement" id="planned_improvement" class="mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2 px-3">
                        <option value="Not decided" {% if version and version.planned_improvement == 'Not decided' %}selected{% endif %}>Pas encore décidé</option>
                        <option value="Yes" {% if version and version.planned_improvement == 'Yes' %}selected{% endif %}>Oui</option>
                        <option value="No" {% if version and version.planned_improvement == 'No' %}selected{% endif %}>Non</option>
                    </select>
                </div>

                <div>
                    <label for="improvement_type" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Type d'amélioration</label>
                    <select name="improvement_type" id="improvement_type" class="mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2 px-3">
                        <option value="Not decided" {% if version and version.improvement_type == 'Not decided' %}selected{% endif %}>Pas encore décidé</option>
                        <option value="Patch" {% if version and version.improvement_type == 'Patch' %}selected{% endif %}>Patch (+0.0.1)</option>
                        <option value="Minor" {% if version and version.improvement_type == 'Minor' %}selected{% endif %}>Mineur (+0.1.0)</option>
                        <option value="Major" {% if version and version.improvement_type == 'Major' %}selected{% endif %}>Majeur (+1.0.0)</option>
                    </select>
                </div>

                <div>
                    <label for="difficulty_level" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Difficulté</label>
                    <select name="difficulty_level" id="difficulty_level" class="mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2 px-3">
                        <option value="Not decided" {% if version and version.difficulty_level == 'Not decided' %}selected{% endif %}>Pas encore décidé</option>
                        <option value="Easy" {% if version and version.difficulty_level == 'Easy' %}selected{% endif %}>Easy</option>
                        <option value="Medium" {% if version and version.difficulty_level == 'Medium' %}selected{% endif %}>Moyen</option>
                        <option value="Hard" {% if version and version.difficulty_level == 'Hard' %}selected{% endif %}>Hard</option>
                    </select>
                </div>

                <div>
                    <label for="priority_level" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Priorité</label>
                    <select name="priority_level" id="priority_level" class="mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2 px-3">
                        <option value="Low" {% if version and version.priority_level == 'Low' %}selected{% endif %}>Low</option>
                        <option value="Medium" {% if version and version.priority_level == 'Medium' %}selected{% endif %}>Medium</option>
                        <option value="High" {% if version and version.priority_level == 'High' %}selected{% endif %}>High</option>
                        <option value="Urgent" {% if version and version.priority_level == 'Urgent' %}selected{% endif %}>Urgent</option>
                    </select>
                </div>
            </div>

            <!-- Custom Fields Section (Only for New Project here, Edit handles it in Detail view usually, but let's allow adding on creation) -->
            {% if not project %}
            <div class="border-t border-gray-200 dark:border-slate-700 pt-6">
                <h4 class="text-md font-medium text-gray-900 dark:text-white mb-4">Champs Personnalisés (Optionnel)</h4>
                <div id="custom-fields-container" class="space-y-3">
                    <!-- Dynamic fields will be added here -->
                </div>
                <button type="button" onclick="addCustomField()" class="mt-3 inline-flex items-center px-3 py-1.5 border border-gray-300 dark:border-slate-600 shadow-sm text-xs font-medium rounded text-gray-700 dark:text-gray-300 bg-white dark:bg-slate-700 hover:bg-gray-50 dark:hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                    + Ajouter un champ
                </button>
            </div>
            {% endif %}

            <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200 dark:border-slate-700">
                <a href="{{ url_for('projects_list') }}" class="px-4 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-slate-700 hover:bg-gray-50 dark:hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                    Annuler
                </a>
                <button type="submit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                    {% if project %}Enregistrer les modifications{% else %}Créer le Projet{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function addCustomField() {
        const container = document.getElementById('custom-fields-container');
        const div = document.createElement('div');
        div.className = 'flex space-x-3';
        div.innerHTML = `
            <input type="text" name="custom_field_name[]" placeholder="Nom du champ (ex: Client)" class="flex-1 rounded-md border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2 px-3">
            <input type="text" name="custom_field_value[]" placeholder="Valeur" class="flex-1 rounded-md border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2 px-3">
            <button type="button" onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        `;
        container.appendChild(div);
    }
</script>
{% endblock %}
